# Pwntools - shellcraft
## Table of Contents
-	[Shellcraft](#Shellcraft)
-	[Local Shellcode](#Local-Shellcode)
-	[Bind Shellcode](#Bind-Shellcode)
-	[Reverse Shellcode](#Reverse-Shellcode)



related link: http://docs.pwntools.com/en/stable/shellcraft.html

## Shellcraft
-	nói 1 cách ngắn gọn thì module shellcraft này dùng để tạo 1 payload dựa theo yêu cầu của user
-	hỗ trợ nhiều hàm để có thể thuận tiện viết shellcode

|Architechture|operating system|
|-------------|----------------|
|AArch64, AMD64, ARM, intel80386, MIPS, Thumb|linux, freebsd|

**NOTE**: đôi khi shellcraft không thực sự chính xác 100%, vì vậy cần phải cẩn trọng trong việc tạo shellcode

## Local Shellcode
```
shellcraft.[arch].[OS].sh()
```
với đoạn code trên là ta có thể tạo ra 1 đoạn shell `execve('/bin/sh')` đơn giản với các arch, os được hỗ trợ

*	example:

![](https://i.imgur.com/EgzHMxn.png)

## Bind Shellcode
bạn có thể đọc thêm [link](https://www.lazenca.net/display/TEC/03.Bind+Shellcode) để biết thêm chi tiết về Bind Shellcode. Nói nôm na thì ta có thể hiểu là trong program có tạo socket để communicate qua host, port.

tương tự với local shellcode, ta chỉ cần đổi `sh` thành `bindsh` là có thể tự tạo 1 bind shellcode

**NOTE**: arg1 = port, arg2 = loại IP(thường là 'ipv4')
![](https://i.imgur.com/vz0VMPd.png)


## Reverse Shellcode

tương tự như Bind Shellcode trên, nhưng thay vì phải đợi host mở port ra thì ta dùng host chính mình để listen respone từ server

-	đầu tiên ta listen ở port mà ta muốn:

![](https://i.imgur.com/eM9GGlf.png)

-	sau đó tạo reverse shell là có thể listen:

![](https://i.imgur.com/xJLEDWo.png)

-	đã listen:

![](https://i.imgur.com/vc8NTIi.png)


## 1 số hàm thường dùng

-	pushstr: push strings vào stack

```py
>>> print shellcraft.pushstr('/home/flag.txt')
    /* push '/home/flag.txt\x00' */
    push 0x1010101
    xor dword ptr [esp], 0x1017579
    push 0x742e6761
    push 0x6c662f65
    push 0x6d6f682f
```

-	syscall: gọi syscall với cái param như sau
	-	1:	tên gọi syscall ("SYS_read" hoặc 0)
	-	2,3,4,5,6: các param về sau

```py
>>> print shellcraft.syscall('SYS_mmap', 0, 0x1000,'PROT_READ | PROT_WRITE | PROT_EXEC', 'MAP_PRIVATE | MAP_ANONYMOUS', 0, 0)
    /* call mmap(0, 0x1000, 'PROT_READ | PROT_WRITE | PROT_EXEC', 'MAP_PRIVATE | MAP_ANONYMOUS', 0, 0) */
    push SYS_mmap /* 0x5a */
    pop eax
    xor ebp, ebp
    xor ebx, ebx
    xor ecx, ecx
    mov ch, 0x1000 >> 8
    xor edi, edi
    push (PROT_READ | PROT_WRITE | PROT_EXEC) /* 7 */
    pop edx
    push (MAP_PRIVATE | MAP_ANONYMOUS) /* 0x22 */
    pop esi
    int 0x80
```

-	và 1 số hàm rút gọn thay vì gọi syscall như trên thì ta có thể
```py
>>> print shellcraft.open('flag.txt')
    /* open(file='flag.txt', oflag=0, mode=0) */
    /* push 'flag.txt\x00' */
    push 1
    dec byte ptr [esp]
    push 0x7478742e
    push 0x67616c66
    mov ebx, esp
    xor ecx, ecx
    xor edx, edx
    /* call open() */
    push SYS_open /* 5 */
    pop eax
    int 0x80
```